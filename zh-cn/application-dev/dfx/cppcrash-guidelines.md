# 分析CppCrash（进程崩溃）

进程崩溃指C/C++运行时崩溃。FaultLogger模块提供进程崩溃故障检测、日志采集、日志存储、日志上报的能力，为开发者提供详细的维测日志以辅助故障定位。

本文将分别介绍进程崩溃检测能力、崩溃日志获取和进程崩溃日志分析。在使用本指导分析日志前，需要开发者对C/C++程序堆栈信息有相关基础知识。

## 进程崩溃检测能力

进程崩溃基于Linux信号机制，目前主要支持对以下崩溃异常信号的处理：

| 信号值 | 信号 | 解释 | 触发原因 |
| -------- | -------- | -------- | -------- |
| 4 | SIGILL | 非法指令。 | 进程执行了非法、格式错误、未知或特权指令。 |
| 5 | SIGTRAP | 断点或陷阱异常。 | 异常或trap指令发生。 |
| 6 | SIGABRT | 进程终止。 | 进程异常终止，通常为进程自身调用标准函数库的abort()函数。 |
| 7 | SIGBUS | 非法内存访问。 | 进程访问了对齐或者不存在的物理地址。 |
| 8 | SIGFPE | 浮点异常。 | 进程执行了错误的算术运算，如除数为0、浮点溢出、整数溢出等。 |
| 11 | SIGSEGV | 无效内存访问。 | 进程访问了无效内存引用。 |
| 16 | SIGSTKFLT | 栈错误。 | 处理器执行了错误的栈操作，如栈空时弹出、栈满时压入。 |
| 31 | SIGSYS | 错误的系统调用。 | 系统调用时使用了错误或非法参数。 |

## 崩溃日志获取

进程崩溃日志是一种故障日志，与应用无响应日志、JS应用崩溃等都由FaultLogger模块进行管理，可通过如下三种方式获取：

- 方式一：通过shell获取日志

    1. 进程崩溃后，CppCrash文件会生成在`设备/data/log/faultlog/faultlogger/`路径下，故障日志文件名格式为“cppcrash-进程名-进程UID-秒级时间”，包含设备名、系统版本、进程崩溃调用栈等信息。

        ![cppcrash-faultlogger-log](figures/20230407112159.png)

    2. `设备/data/log/faultlog/temp/`路径下的故障日志，其文件名格式为“cppcrash-进程PID-系统毫秒级时间戳”，包含进程崩溃时栈内存、进程maps等信息。

        ![cppcrash-temp-log](figures/20230407111853.png)

- 方式二：通过DevEco Studio获取日志

    DevEco Studio会收集`设备/data/log/faultlog/faultlogger/`路径下的进程崩溃故障日志到FaultLog下，根据进程名和故障和时间分类显示。获取日志的方法参见：[DevEco Studio使用指南-FaultLog](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V2/ide-debug-hilog-0000001172459337-V2#section974519209435)。

- 方式三：通过faultlogger接口获取

    FaultLogger对外提供了面向应用的故障查询接口，可以查询应用自己的故障记录，以结构化的数据返回。接口的使用以及获取的故障信息规格详见[@ohos.faultLogger (故障日志获取)](../reference/apis-performance-analysis-kit/js-apis-faultLogger.md)。

## 进程崩溃日志分析


### 日志格式 - 空指针故障场景

以下是一份DevEco Studio归档在FaultLog的进程崩溃日志的核心内容，与`设备/data/log/faultlog/faultlogger`下归档的日志内容相同。

```
Generated by HiviewDFX@OpenHarmony
================================================================
Device info:OpenHarmony 3.2        <- 设备信息
Build info:OpenHarmony 5.0.0.23    <- 版本信息
Fingerprint:cdf52fd0cc328fc432459928f3ed8edfe8a72a92ee7316445143bed179138073 <- 标识故障特征
Module name:crasher_cpp            <- 模块名
Timestamp:2024-05-06 20:10:51.000  <- 故障发生时间戳
Pid:9623   <- 进程号
Uid:0         <- 用户ID
Process name:./crasher_cpp         <- 进程名称
Process life time:1s               <- 进程存活时间
Reason:Signal:SIGSEGV(SEGV_MAPERR)@0x00000004  probably caused by NULL pointer dereference   <- 故障原因和空指针提示
Fault thread info:
Tid:9623, Name:crasher_cpp         <- 故障线程号,线程名
#00 pc 00008d22 /system/bin/crasher_cpp(TestNullPointerDereferenceCrash0()+22)(adfc673300571d2da1e47d1d12f48b44)  <- 调用栈
#01 pc 000064d1 /system/bin/crasher_cpp(DfxCrasher::ParseAndDoCrash(char const*) const+160)(adfc673300571d2da1e47d1d12f48b44)
#02 pc 00006569 /system/bin/crasher_cpp(main+92)(adfc673300571d2da1e47d1d12f48b44)
#03 pc 00072b98 /system/lib/ld-musl-arm.so.1(libc_start_main_stage2+56)(d820b1827e57855d4f9ed03ba5dfea83)
#04 pc 00004e28 /system/bin/crasher_cpp(_start_c+84)(adfc673300571d2da1e47d1d12f48b44)
#05 pc 00004dcc /system/bin/crasher_cpp(adfc673300571d2da1e47d1d12f48b44)
Registers:   <- 故障现场寄存器
r0:ffffafd2 r1:00000004 r2:00000001 r3:00000000
r4:ffd27e39 r5:0096e000 r6:00000a40 r7:0096fdfc
r8:f7ba58d5 r9:f7baea86 r10:f7cadd38
fp:ffd27308 ip:f7cb2078 sp:ffd272a0 lr:f7c7ab98 pc:0096ad22
Memory near registers:  <-  故障现场寄存器附近内存
r4([stack]):
    ffd27e30 72656873
    ffd27e34 7070635f
    ...
    ffd27eac 3d73746f
r5(/system/bin/crasher_cpp):
    0096dff8 00000000
    0096dffc 0096717d
    ...
    0096e074 00000000
r7(/system/lib/ld-musl-arm.so.1):
    f7cabb58 00000000
    f7cabb5c 0034ba00
    ...
    f7cabbd4 00000000
r8(/system/lib/ld-musl-arm.so.1):
    f7ba58cc 63637573
    f7ba58d0 2e737365
    ...
    f7ba5948 70206269
r9(/system/lib/ld-musl-arm.so.1):
    f7baea7c 20746f6e
    f7baea80 6e756f66
    ...
    f7baeaf8 25206e69
r10([anon:ld-musl-arm.so.1.bss]):
    f7cadd30 00000000
    f7cadd34 00000000
    ...
    f7caddac 00000000
r12([anon:ld-musl-arm.so.1.bss]):
    f7cb2070 56726562
    f7cb2074 65756c61
    ...
    f7cb20ec 00000000
sp([stack]):
    ffd27328 00000000
    ffd2732c 00966dd0
    ...
    ffd273a4 00000004
pc(/system/bin/crasher_cpp):
    00966dc8 e1a0d00c
    00966dcc eb000000
    ...
    00966e44 e5907008
pc(/system/bin/crasher_cpp):
    00966dc8 e1a0d00c
    00966dcc eb000000
    ...
    00966e44 e5907008
FaultStack:   <- 崩溃线程的栈地址空间
    ffd27260 00000000
    ffd27264 f7cac628
    ...
    ffd2729c 0096ad1f
sp0:ffd272a0 0096fdfc <- #00栈顶
    ffd272a4 009684d3
sp1:ffd272a8 00000001
    ffd272ac 73657408
    ffd272b0 f7590074
    ...
    ffd272dc 0096856d
sp2:ffd272e0 ffd27334
    ffd272e4 ffd27334
    ffd272e8 00000002
    ....
    ffd272f4 f7bfbb9c
sp3:ffd272f8 00000000
    ffd272fc ffd27334

Maps:   <-  故障时进程maps
962000-966000 r--p 00000000 /system/bin/crasher_cpp
966000-96c000 r-xp 00003000 /system/bin/crasher_cpp
96c000-96f000 r--p 00008000 /system/bin/crasher_cpp
96f000-970000 rw-p 0000a000 /system/bin/crasher_cpp
149f000-14a0000 ---p 00000000 [heap]
14a0000-14a2000 rw-p 00000000 [heap]
...
f7b89000-f7be1000 r--p 00000000 /system/lib/ld-musl-arm.so.1
f7be1000-f7ca9000 r-xp 00057000 /system/lib/ld-musl-arm.so.1
f7ca9000-f7cab000 r--p 0011e000 /system/lib/ld-musl-arm.so.1
f7cab000-f7cad000 rw-p 0011f000 /system/lib/ld-musl-arm.so.1
f7cad000-f7cbc000 rw-p 00000000 [anon:ld-musl-arm.so.1.bss]
ffd07000-ffd28000 rw-p 00000000 [stack]
ffff0000-ffff1000 r-xp 00000000 [vectors]
OpenFiles:   <-  故障时进程打开文件Fd信息
0->/dev/pts/1 native object of unknown type 0
1->/dev/pts/1 native object of unknown type 0
2->/dev/pts/1 native object of unknown type 0
3->socket:[67214] native object of unknown type 0
...
11->pipe:[67219] native object of unknown type 0
12->socket:[29074] native object of unknown type 0
25->/dev/ptmx native object of unknown type 0
26->/dev/ptmx native object of unknown type 0

HiLog:   <-  故障时的Hilog日志
05-06 20:10:51.301  9623  9623 E C03f00/MUSL-SIGCHAIN: signal_chain_handler call 2 rd sigchain action for signal: 11
05-06 20:10:51.306  9623  9623 I C02d11/DfxSignalHandler: DFX_SigchainHandler :: sig(11), pid(9623), tid(9623).
05-06 20:10:51.307  9623  9623 I C02d11/DfxSignalHandler: DFX_SigchainHandler :: sig(11), pid(9623), processName(./crasher_cpp), threadName(crasher_cpp).
05-06 20:10:51.389  9623  9623 I C02d11/DfxSignalHandler: processdump have get all resgs

```


通过Shell获取的`/data/log/faultlog/temp`获取到的日志内容格式如下：


```
Timestamp:2024-05-06 20:10:51.000  <- 故障发生时间戳
Pid:9623                           <- 进程号
Uid:0                              <- 用户ID
Process name:./crasher_cpp         <- 进程名称
Process life time:1s               <- 进程存活时间
Reason:Signal:SIGSEGV(SEGV_MAPERR)@0x00000004  probably caused by NULL pointer dereference   <- 故障原因和空指针提示
Fault thread info:
Tid:9623, Name:crasher_cpp         <- 故障线程号,线程名
#00 pc 00008d22 /system/bin/crasher_cpp(TestNullPointerDereferenceCrash0()+22)(adfc673300571d2da1e47d1d12f48b44)  <- 调用栈
#01 pc 000064d1 /system/bin/crasher_cpp(DfxCrasher::ParseAndDoCrash(char const*) const+160)(adfc673300571d2da1e47d1d12f48b44)
#02 pc 00006569 /system/bin/crasher_cpp(main+92)(adfc673300571d2da1e47d1d12f48b44)
#03 pc 00072b98 /system/lib/ld-musl-arm.so.1(libc_start_main_stage2+56)(d820b1827e57855d4f9ed03ba5dfea83)
#04 pc 00004e28 /system/bin/crasher_cpp(_start_c+84)(adfc673300571d2da1e47d1d12f48b44)
#05 pc 00004dcc /system/bin/crasher_cpp(adfc673300571d2da1e47d1d12f48b44)
Registers:   <- 故障现场寄存器
r0:ffffafd2 r1:00000004 r2:00000001 r3:00000000
r4:ffd27e39 r5:0096e000 r6:00000a40 r7:0096fdfc
r8:f7ba58d5 r9:f7baea86 r10:f7cadd38
fp:ffd27308 ip:f7cb2078 sp:ffd272a0 lr:f7c7ab98 pc:0096ad22
Memory near registers:  <-  故障现场寄存器附近内存
r4([stack]):
    ffd27e30 72656873
    ffd27e34 7070635f
    ...
    ffd27eac 3d73746f
r5(/system/bin/crasher_cpp):
    0096dff8 00000000
    0096dffc 0096717d
    ...
    0096e074 00000000
r7(/system/lib/ld-musl-arm.so.1):
    f7cabb58 00000000
    f7cabb5c 0034ba00
    ...
    f7cabbd4 00000000
r8(/system/lib/ld-musl-arm.so.1):
    f7ba58cc 63637573
    f7ba58d0 2e737365
    ...
    f7ba5948 70206269
r9(/system/lib/ld-musl-arm.so.1):
    f7baea7c 20746f6e
    f7baea80 6e756f66
    ...
    f7baeaf8 25206e69
r10([anon:ld-musl-arm.so.1.bss]):
    f7cadd30 00000000
    f7cadd34 00000000
    ...
    f7caddac 00000000
r12([anon:ld-musl-arm.so.1.bss]):
    f7cb2070 56726562
    f7cb2074 65756c61
    ...
    f7cb20ec 00000000
sp([stack]):
    ffd27328 00000000
    ffd2732c 00966dd0
    ...
    ffd273a4 00000004
pc(/system/bin/crasher_cpp):
    00966dc8 e1a0d00c
    00966dcc eb000000
    ...
    00966e44 e5907008
pc(/system/bin/crasher_cpp):
    00966dc8 e1a0d00c
    00966dcc eb000000
    ...
    00966e44 e5907008
FaultStack:   <- 崩溃线程的栈地址空间
    ffd27260 00000000
    ffd27264 f7cac628
    ...
    ffd2729c 0096ad1f
sp0:ffd272a0 0096fdfc <- #00栈顶
    ffd272a4 009684d3
sp1:ffd272a8 00000001
    ffd272ac 73657408
    ffd272b0 f7590074
    ...
    ffd272dc 0096856d
sp2:ffd272e0 ffd27334
    ffd272e4 ffd27334
    ffd272e8 00000002
    ....
    ffd272f4 f7bfbb9c
sp3:ffd272f8 00000000
    ffd272fc ffd27334

Maps:   <-  故障时进程maps
962000-966000 r--p 00000000 /system/bin/crasher_cpp
966000-96c000 r-xp 00003000 /system/bin/crasher_cpp
96c000-96f000 r--p 00008000 /system/bin/crasher_cpp
96f000-970000 rw-p 0000a000 /system/bin/crasher_cpp
149f000-14a0000 ---p 00000000 [heap]
14a0000-14a2000 rw-p 00000000 [heap]
...
f7b89000-f7be1000 r--p 00000000 /system/lib/ld-musl-arm.so.1
f7be1000-f7ca9000 r-xp 00057000 /system/lib/ld-musl-arm.so.1
f7ca9000-f7cab000 r--p 0011e000 /system/lib/ld-musl-arm.so.1
f7cab000-f7cad000 rw-p 0011f000 /system/lib/ld-musl-arm.so.1
f7cad000-f7cbc000 rw-p 00000000 [anon:ld-musl-arm.so.1.bss]
ffd07000-ffd28000 rw-p 00000000 [stack]
ffff0000-ffff1000 r-xp 00000000 [vectors]
OpenFiles:   <-  故障时进程打开文件Fd信息
0->/dev/pts/1 native object of unknown type 0
1->/dev/pts/1 native object of unknown type 0
2->/dev/pts/1 native object of unknown type 0
3->socket:[67214] native object of unknown type 0
...
11->pipe:[67219] native object of unknown type 0
12->socket:[29074] native object of unknown type 0
25->/dev/ptmx native object of unknown type 0
26->/dev/ptmx native object of unknown type 0
```

### 日志格式 - 栈溢出故障场景

以下是一份DevEco Studio归档在FaultLog的进程崩溃日志的核心内容，与`设备/data/log/faultlog/faultlogger`下归档的日志内容相同。

```
Generated by HiviewDFX@OpenHarmony
================================================================
Device info:OpenHarmony 3.2            <- 设备信息
Build info:OpenHarmony 5.0.0.23        <- 版本信息
Fingerprint:8bc3343f50024204e258b8dce86f41f8fcc50c4d25d56b24e71fe26c0a23e321  <- 标识故障特征
Module name:crasher_cpp                <- 模块名
Timestamp:2024-05-06 20:18:24.000      <- 故障发生时间戳
Pid:9838                               <- 进程号
Uid:0                                  <- 用户ID
Process name:./crasher_cpp             <- 进程名称
Process life time:2s                   <- 进程存活时间
Reason:Signal:SIGSEGV(SEGV_ACCERR)@0xf76b7ffc  current thread stack low address = 0xf76b8000, probably caused by stack-buffer-overflow    <- 故障原因和栈溢出提示
Fault thread info:
Tid:9839, Name:crasher_cpp             <- 故障线程号,线程名
#00 pc 000054e6 /system/bin/crasher_cpp(DoStackOverflow(void*)+42)(adfc673300571d2da1e47d1d12f48b44)  <- 调用栈
#01 pc 000054f9 /system/bin/crasher_cpp(DoStackOverflow(void*)+60)(adfc673300571d2da1e47d1d12f48b44)
#02 pc 000054f9 /system/bin/crasher_cpp(DoStackOverflow(void*)+60)(adfc673300571d2da1e47d1d12f48b44)
#03 pc 000054f9 /system/bin/crasher_cpp(DoStackOverflow(void*)+60)(adfc673300571d2da1e47d1d12f48b44)
#04 pc 000054f9 /system/bin/crasher_cpp(DoStackOverflow(void*)+60)(adfc673300571d2da1e47d1d12f48b44)
#05 pc 000054f9 /system/bin/crasher_cpp(DoStackOverflow(void*)+60)(adfc673300571d2da1e47d1d12f48b44)
#06 pc 000054f9 /system/bin/crasher_cpp(DoStackOverflow(void*)+60)(adfc673300571d2da1e47d1d12f48b44)
...
#180 pc 0010783c /system/lib/ld-musl-arm.so.1(start+248)(d820b1827e57855d4f9ed03ba5dfea83)
#181 pc 00070458 /system/lib/ld-musl-arm.so.1(d820b1827e57855d4f9ed03ba5dfea83)
Registers:    <- 故障现场寄存器
r0:00000001 r1:00000000 r2:f76b7ffc r3:00000004
r4:f76b7ffc r5:00000000 r6:f76bad14 r7:000000af
r8:f78514a0 r9:f76bad28 r10:f76bad1c
fp:f76bad08 ip:00000004 sp:f76b7ff8 lr:00a544fd pc:00a544e6
Other thread info:   <- 其他线程信息
Tid:9838, Name:crasher_cpp   <- 线程号,线程名
#00 pc 00103cbc /system/lib/ld-musl-arm.so.1(__timedwait_cp+200)(d820b1827e57855d4f9ed03ba5dfea83)  <- 调用栈
#01 pc 00109284 /system/lib/ld-musl-arm.so.1(__pthread_mutex_timedlock_inner+692)(d820b1827e57855d4f9ed03ba5dfea83)
#02 pc 000811c0 /system/lib/ld-musl-arm.so.1(PauseMainThreadHandler+84)(d820b1827e57855d4f9ed03ba5dfea83)
#03 pc 0007029c /system/lib/ld-musl-arm.so.1(d820b1827e57855d4f9ed03ba5dfea83)
#04 pc 00107f68 /system/lib/ld-musl-arm.so.1(__pthread_join+88)(d820b1827e57855d4f9ed03ba5dfea83)
#05 pc 00005489 /system/bin/crasher_cpp(DfxCrasher::StackOverflow()+152)(adfc673300571d2da1e47d1d12f48b44)
#06 pc 000064d1 /system/bin/crasher_cpp(DfxCrasher::ParseAndDoCrash(char const*) const+160)(adfc673300571d2da1e47d1d12f48b44)
#07 pc 00006569 /system/bin/crasher_cpp(main+92)(adfc673300571d2da1e47d1d12f48b44)
#08 pc 00072b98 /system/lib/ld-musl-arm.so.1(libc_start_main_stage2+56)(d820b1827e57855d4f9ed03ba5dfea83)
#09 pc 00004e28 /system/bin/crasher_cpp(_start_c+84)(adfc673300571d2da1e47d1d12f48b44)
#10 pc 00004dcc /system/bin/crasher_cpp(adfc673300571d2da1e47d1d12f48b44)
Memory near registers:  <-  故障现场寄存器附近内存
r6([anon:stack:9839]):
    f76bad0c f779845c
    f76bad10 00000000
    ...
    f76bad88 f7851990
r8([anon:ld-musl-arm.so.1.bss]):
    f7851498 00000000
    f785149c 00000000
    ...
    f7851514 00000000
r9([anon:stack:9839]):
    f76bad20 00000000
    f76bad24 00000000
    ...
    f76bad9c 00000000
r10([anon:stack:9839]):
    f76bad14 00a544bd
    f76bad18 00000000
    ...
    f76bad90 00000000
fp([stack]):
    fffe8fd0 000011f0
    fffe8fd4 00a5cdfc
    ...
    fffe904c 975ddb02
sp([anon:stack:9839]):
    f76bad08 fffe8fd8
    f76bad0c f779845c
    ...
    f76bad84 00000000
pc(/system/lib/ld-musl-arm.so.1):
    f7798454 e1a00006
    f7798458 eb000002
    ...
    f77984d0 eb000169
pc(/system/lib/ld-musl-arm.so.1):
    f7798454 e1a00006
    f7798458 eb000002
    ...
    f77984d0 eb000169
FaultStack:            <- 崩溃线程的栈地址空间
    f76b7fb8 00000000
    f76b7fbc 00000000
    ...
    f76b7ff4 00000000
sp0:f76b7ff8 00000000  <- #00栈顶
    f76b7ffc 00000000
    ...
    f76b8034 00a544fd
sp1:f76b8038 00000000
    f76b803c 00000001
    ...
    f76b8074 00a544fd
sp2:f76b8078 00000000
    f76b807c 00000001
    ...
    f76b80b4 00a544fd
sp3:f76b80b8 00000000
    f76b80bc 00000001
    ...
    f76b80e4 975ddb02

Maps:    <- 故障时进程maps
a4f000-a53000 r--p 00000000 /system/bin/crasher_cpp
a53000-a59000 r-xp 00003000 /system/bin/crasher_cpp
a59000-a5c000 r--p 00008000 /system/bin/crasher_cpp
a5c000-a5d000 rw-p 0000a000 /system/bin/crasher_cpp
e4e000-e4f000 ---p 00000000 [heap]
e4f000-e51000 rw-p 00000000 [heap]
...
f7728000-f7780000 r--p 00000000 /system/lib/ld-musl-arm.so.1
f7780000-f7848000 r-xp 00057000 /system/lib/ld-musl-arm.so.1
f7848000-f784a000 r--p 0011e000 /system/lib/ld-musl-arm.so.1
f784a000-f784c000 rw-p 0011f000 /system/lib/ld-musl-arm.so.1
f784c000-f785b000 rw-p 00000000 [anon:ld-musl-arm.so.1.bss]
fffc9000-fffea000 rw-p 00000000 [stack]
ffff0000-ffff1000 r-xp 00000000 [vectors]
OpenFiles:     <- 故障时进程打开文件Fd信息
0->/dev/pts/1 native object of unknown type 0
1->/dev/pts/1 native object of unknown type 0
2->/dev/pts/1 native object of unknown type 0
3->socket:[68408] native object of unknown type 0
...
11->pipe:[68414] native object of unknown type 0
12->socket:[29074] native object of unknown type 0
25->/dev/ptmx native object of unknown type 0
26->/dev/ptmx native object of unknown type 0

HiLog:     <- 故障时的Hilog日志
05-06 20:18:24.089  9838  9839 E C03f00/MUSL-SIGCHAIN: signal_chain_handler call 2 rd sigchain action for signal: 11
05-06 20:18:24.089  9838  9839 I C02d11/DfxSignalHandler: DFX_SigchainHandler :: sig(11), pid(9838), tid(9839).
05-06 20:18:24.089  9838  9839 I C02d11/DfxSignalHandler: Try block main thread.
05-06 20:18:24.089  9838  9838 I C02d11/DfxSignalHandler: Crash(3) in child thread(9838), lock main thread.
05-06 20:18:24.090  9838  9839 I C02d11/DfxSignalHandler: DFX_SigchainHandler :: sig(11), pid(9838), processName(./crasher_cpp), threadName(crasher_cpp).
05-06 20:18:24.122  9838  9839 I C02d11/DfxSignalHandler: processdump have get all resgs
```


通过Shell获取的`/data/log/faultlog/temp`获取到的日志内容格式如下：


```
Timestamp:2024-05-06 20:18:24.000               <- 故障发生时间戳
Pid:9838                                        <- 进程号
Uid:0                                           <- 用户ID
Process name:./crasher_cpp                      <- 进程名称
Process life time:2s                            <- 进程存活时间
Reason:Signal:SIGSEGV(SEGV_ACCERR)@0xf76b7ffc  current thread stack low address = 0xf76b8000, probably caused by stack-buffer-overflow     <- 故障原因和栈溢出提示
Fault thread info:
Tid:9839, Name:crasher_cpp                      <- 故障线程号,线程名
#00 pc 000054e6 /system/bin/crasher_cpp(DoStackOverflow(void*)+42)(adfc673300571d2da1e47d1d12f48b44)  <- 调用栈
#01 pc 000054f9 /system/bin/crasher_cpp(DoStackOverflow(void*)+60)(adfc673300571d2da1e47d1d12f48b44)
#02 pc 000054f9 /system/bin/crasher_cpp(DoStackOverflow(void*)+60)(adfc673300571d2da1e47d1d12f48b44)
#03 pc 000054f9 /system/bin/crasher_cpp(DoStackOverflow(void*)+60)(adfc673300571d2da1e47d1d12f48b44)
#04 pc 000054f9 /system/bin/crasher_cpp(DoStackOverflow(void*)+60)(adfc673300571d2da1e47d1d12f48b44)
#05 pc 000054f9 /system/bin/crasher_cpp(DoStackOverflow(void*)+60)(adfc673300571d2da1e47d1d12f48b44)
#06 pc 000054f9 /system/bin/crasher_cpp(DoStackOverflow(void*)+60)(adfc673300571d2da1e47d1d12f48b44)
...
#180 pc 0010783c /system/lib/ld-musl-arm.so.1(start+248)(d820b1827e57855d4f9ed03ba5dfea83)
#181 pc 00070458 /system/lib/ld-musl-arm.so.1(d820b1827e57855d4f9ed03ba5dfea83)
Registers:    <- 故障现场寄存器
r0:00000001 r1:00000000 r2:f76b7ffc r3:00000004
r4:f76b7ffc r5:00000000 r6:f76bad14 r7:000000af
r8:f78514a0 r9:f76bad28 r10:f76bad1c
fp:f76bad08 ip:00000004 sp:f76b7ff8 lr:00a544fd pc:00a544e6
Other thread info:           <- 其他线程信息
Tid:9838, Name:crasher_cpp   <- 线程号,线程名
#00 pc 00103cbc /system/lib/ld-musl-arm.so.1(__timedwait_cp+200)(d820b1827e57855d4f9ed03ba5dfea83)  <- 调用栈
#01 pc 00109284 /system/lib/ld-musl-arm.so.1(__pthread_mutex_timedlock_inner+692)(d820b1827e57855d4f9ed03ba5dfea83)
#02 pc 000811c0 /system/lib/ld-musl-arm.so.1(PauseMainThreadHandler+84)(d820b1827e57855d4f9ed03ba5dfea83)
#03 pc 0007029c /system/lib/ld-musl-arm.so.1(d820b1827e57855d4f9ed03ba5dfea83)
#04 pc 00107f68 /system/lib/ld-musl-arm.so.1(__pthread_join+88)(d820b1827e57855d4f9ed03ba5dfea83)
#05 pc 00005489 /system/bin/crasher_cpp(DfxCrasher::StackOverflow()+152)(adfc673300571d2da1e47d1d12f48b44)
#06 pc 000064d1 /system/bin/crasher_cpp(DfxCrasher::ParseAndDoCrash(char const*) const+160)(adfc673300571d2da1e47d1d12f48b44)
#07 pc 00006569 /system/bin/crasher_cpp(main+92)(adfc673300571d2da1e47d1d12f48b44)
#08 pc 00072b98 /system/lib/ld-musl-arm.so.1(libc_start_main_stage2+56)(d820b1827e57855d4f9ed03ba5dfea83)
#09 pc 00004e28 /system/bin/crasher_cpp(_start_c+84)(adfc673300571d2da1e47d1d12f48b44)
#10 pc 00004dcc /system/bin/crasher_cpp(adfc673300571d2da1e47d1d12f48b44)
Memory near registers:  <- 故障现场寄存器附近内存
r6([anon:stack:9839]):
    f76bad0c f779845c
    f76bad10 00000000
    ...
    f76bad88 f7851990
r8([anon:ld-musl-arm.so.1.bss]):
    f7851498 00000000
    f785149c 00000000
    ...
    f7851514 00000000
r9([anon:stack:9839]):
    f76bad20 00000000
    f76bad24 00000000
    ...
    f76bad9c 00000000
r10([anon:stack:9839]):
    f76bad14 00a544bd
    f76bad18 00000000
    ...
    f76bad90 00000000
fp([stack]):
    fffe8fd0 000011f0
    fffe8fd4 00a5cdfc
    ...
    fffe904c 975ddb02
sp([anon:stack:9839]):
    f76bad08 fffe8fd8
    f76bad0c f779845c
    ...
    f76bad84 00000000
pc(/system/lib/ld-musl-arm.so.1):
    f7798454 e1a00006
    f7798458 eb000002
    ...
    f77984d0 eb000169
pc(/system/lib/ld-musl-arm.so.1):
    f7798454 e1a00006
    f7798458 eb000002
    ...
    f77984d0 eb000169
FaultStack:            <- 崩溃线程的栈地址空间
    f76b7fb8 00000000
    f76b7fbc 00000000
    ...
    f76b7ff4 00000000
sp0:f76b7ff8 00000000  <- #00栈顶
    f76b7ffc 00000000
    ...
    f76b8034 00a544fd
sp1:f76b8038 00000000
    f76b803c 00000001
    ...
    f76b8074 00a544fd
sp2:f76b8078 00000000
    f76b807c 00000001
    ...
    f76b80b4 00a544fd
sp3:f76b80b8 00000000
    f76b80bc 00000001
    ...
    f76b80e4 975ddb02

Maps:    <- 故障时进程maps
a4f000-a53000 r--p 00000000 /system/bin/crasher_cpp
a53000-a59000 r-xp 00003000 /system/bin/crasher_cpp
a59000-a5c000 r--p 00008000 /system/bin/crasher_cpp
a5c000-a5d000 rw-p 0000a000 /system/bin/crasher_cpp
e4e000-e4f000 ---p 00000000 [heap]
e4f000-e51000 rw-p 00000000 [heap]
...
f7728000-f7780000 r--p 00000000 /system/lib/ld-musl-arm.so.1
f7780000-f7848000 r-xp 00057000 /system/lib/ld-musl-arm.so.1
f7848000-f784a000 r--p 0011e000 /system/lib/ld-musl-arm.so.1
f784a000-f784c000 rw-p 0011f000 /system/lib/ld-musl-arm.so.1
f784c000-f785b000 rw-p 00000000 [anon:ld-musl-arm.so.1.bss]
fffc9000-fffea000 rw-p 00000000 [stack]
ffff0000-ffff1000 r-xp 00000000 [vectors]
OpenFiles:     <- 故障时进程打开文件Fd信息
0->/dev/pts/1 native object of unknown type 0
1->/dev/pts/1 native object of unknown type 0
2->/dev/pts/1 native object of unknown type 0
3->socket:[68408] native object of unknown type 0
...
11->pipe:[68414] native object of unknown type 0
12->socket:[29074] native object of unknown type 0
25->/dev/ptmx native object of unknown type 0
26->/dev/ptmx native object of unknown type 0
```

### 日志格式 - 栈覆盖故障场景

以下是一份DevEco Studio归档在FaultLog的进程崩溃日志的核心内容，与`设备/data/log/faultlog/faultlogger`下归档的日志内容相同。

```
Generated by HiviewDFX@OpenHarmony
================================================================
Device info:OpenHarmony 3.2               <- 设备信息
Build info:OpenHarmony 5.0.0.23           <- 版本信息
Fingerprint:79b6d47b87495edf27135a83dda8b1b4f9b13d37bda2560d43f2cf65358cd528    <- 标识故障特征
Module name:crasher_cpp                   <- 模块名
Timestamp:2024-05-06 20:27:23.2035266415  <- 故障发生时间戳
Pid:10026                                 <- 进程号
Uid:0                                     <- 用户ID
Process name:./crasher_cpp                <- 进程名称
Process life time:1s                      <- 进程存活时间
Reason:Signal:SIGSEGV(SEGV_MAPERR)@0000000000  probably caused by NULL pointer dereference      <- 故障原因
LastFatalMessage: Failed to unwind stack, try to get unreliable call stack from #02 by reparsing thread stack   <- 尝试从线程栈里获取不可靠的堆栈
Fault thread info:
Tid:10026, Name:crasher_cpp               <- 故障线程号,线程名
#00 pc 00000000 Not mapped
#01 pc 00008d22 /system/bin/crasher_cpp(TestNullPointerDereferenceCrash0()+22)(adfc673300571d2da1e47d1d12f48b44)  <- 调用栈
#02 pc 000064d1 /system/bin/crasher_cpp(DfxCrasher::ParseAndDoCrash(char const*) const+160)(adfc673300571d2da1e47d1d12f48b44)
#03 pc 00006569 /system/bin/crasher_cpp(main+92)(adfc673300571d2da1e47d1d12f48b44)
#04 pc 00072b98 /system/lib/ld-musl-arm.so.1(libc_start_main_stage2+56)(d820b1827e57855d4f9ed03ba5dfea83)
Registers:   <- 故障现场寄存器
r0:ffffafd2 r1:00000004 r2:00000001 r3:00000000
r4:ffd27e39 r5:0096e000 r6:00000a40 r7:0096fdfc
r8:f7ba58d5 r9:f7baea86 r10:f7cadd38
fp:ffd27308 ip:f7cb2078 sp:ffd272a0 lr:f7c7ab98 pc:0096ad22
Memory near registers:  <-  故障现场寄存器附近内存
r4([stack]):
    ffd27e30 72656873
    ffd27e34 7070635f
    ...
    ffd27eac 3d73746f
r5(/system/bin/crasher_cpp):
    0096dff8 00000000
    0096dffc 0096717d
    ...
    0096e074 00000000
r7(/system/lib/ld-musl-arm.so.1):
    f7cabb58 00000000
    f7cabb5c 0034ba00
    ...
    f7cabbd4 00000000
r8(/system/lib/ld-musl-arm.so.1):
    f7ba58cc 63637573
    f7ba58d0 2e737365
    ...
    f7ba5948 70206269
r9(/system/lib/ld-musl-arm.so.1):
    f7baea7c 20746f6e
    f7baea80 6e756f66
    ...
    f7baeaf8 25206e69
r10([anon:ld-musl-arm.so.1.bss]):
    f7cadd30 00000000
    f7cadd34 00000000
    ...
    f7caddac 00000000
r12([anon:ld-musl-arm.so.1.bss]):
    f7cb2070 56726562
    f7cb2074 65756c61
    ...
    f7cb20ec 00000000
sp([stack]):
    ffd27328 00000000
    ffd2732c 00966dd0
    ...
    ffd273a4 00000004
pc(/system/bin/crasher_cpp):
    00966dc8 e1a0d00c
    00966dcc eb000000
    ...
    00966e44 e5907008
pc(/system/bin/crasher_cpp):
    00966dc8 e1a0d00c
    00966dcc eb000000
    ...
    00966e44 e5907008
FaultStack:   <- 崩溃线程的栈地址空间
    ffd27260 00000000
    ffd27264 f7cac628
    ...
    ffd2729c 0096ad1f
sp0:ffd272a0 0096fdfc <- #00栈顶
    ffd272a4 009684d3
sp1:ffd272a8 00000001
    ffd272ac 73657408
    ffd272b0 f7590074
    ...
    ffd272dc 0096856d
sp2:ffd272e0 ffd27334
    ffd272e4 ffd27334
    ffd272e8 00000002
    ....
    ffd272f4 f7bfbb9c
sp3:ffd272f8 00000000
    ffd272fc ffd27334

Maps:   <-  故障时进程maps
962000-966000 r--p 00000000 /system/bin/crasher_cpp
966000-96c000 r-xp 00003000 /system/bin/crasher_cpp
96c000-96f000 r--p 00008000 /system/bin/crasher_cpp
96f000-970000 rw-p 0000a000 /system/bin/crasher_cpp
149f000-14a0000 ---p 00000000 [heap]
14a0000-14a2000 rw-p 00000000 [heap]
...
f7b89000-f7be1000 r--p 00000000 /system/lib/ld-musl-arm.so.1
f7be1000-f7ca9000 r-xp 00057000 /system/lib/ld-musl-arm.so.1
f7ca9000-f7cab000 r--p 0011e000 /system/lib/ld-musl-arm.so.1
f7cab000-f7cad000 rw-p 0011f000 /system/lib/ld-musl-arm.so.1
f7cad000-f7cbc000 rw-p 00000000 [anon:ld-musl-arm.so.1.bss]
ffd07000-ffd28000 rw-p 00000000 [stack]
ffff0000-ffff1000 r-xp 00000000 [vectors]
OpenFiles: <- 故障时进程打开文件Fd信息
0->/dev/pts/1 native object of unknown type 0
1->/dev/pts/1 native object of unknown type 0
2->/dev/pts/1 native object of unknown type 0
3->socket:[69219] native object of unknown type 0
...
11->pipe:[69224] native object of unknown type 0
12->socket:[29074] native object of unknown type 0
25->/dev/ptmx native object of unknown type 0
26->/dev/ptmx native object of unknown type 0

HiLog:   <- 故障时的Hilog日志
05-06 20:27:23.354 10026 10026 E C03f00/MUSL-SIGCHAIN: signal_chain_handler call 0 rd sigchain action for signal: 11
05-06 20:27:23.355 10026 10026 E C03f00/MUSL-SIGCHAIN: signal_chain_handler call 2 rd sigchain action for signal: 11
05-06 20:27:23.355 10026 10026 I C02d11/DfxSignalHandler: DFX_SigchainHandler :: sig(11), pid(10026), tid(10026).
05-06 20:27:23.355 10026 10026 I C02d11/DfxSignalHandler: DFX_SigchainHandler :: sig(11), pid(10026), processName(./crasher_cpp), threadName(crasher_cpp).
05-06 20:27:23.388 10026 10026 I C02d11/DfxSignalHandler: processdump have get all resgs
```


通过Shell获取的`/data/log/faultlog/temp`获取到的日志内容格式如下：


```
Timestamp:2024-05-06 20:27:23.2035266415  <- 故障发生时间戳
Pid:10026                                 <- 进程号
Uid:0                                     <- 用户ID
Process name:./crasher_cpp                <- 进程名称
Process life time:1s                      <- 进程存活时间
Reason:Signal:SIGSEGV(SEGV_MAPERR)@0000000000  probably caused by NULL pointer dereference      <- 故障原因
LastFatalMessage: Failed to unwind stack, try to get unreliable call stack from #02 by reparsing thread stack   <- 尝试从线程栈里获取不可靠的堆栈
Fault thread info:
Tid:10026, Name:crasher_cpp               <- 故障线程号,线程名
#00 pc 00000000 Not mapped
#01 pc 00008d22 /system/bin/crasher_cpp(TestNullPointerDereferenceCrash0()+22)(adfc673300571d2da1e47d1d12f48b44)  <- 调用栈
#02 pc 000064d1 /system/bin/crasher_cpp(DfxCrasher::ParseAndDoCrash(char const*) const+160)(adfc673300571d2da1e47d1d12f48b44)
#03 pc 00006569 /system/bin/crasher_cpp(main+92)(adfc673300571d2da1e47d1d12f48b44)
#04 pc 00072b98 /system/lib/ld-musl-arm.so.1(libc_start_main_stage2+56)(d820b1827e57855d4f9ed03ba5dfea83)
Registers:   <- 故障现场寄存器
r0:ffffafd2 r1:00000004 r2:00000001 r3:00000000
r4:ffd27e39 r5:0096e000 r6:00000a40 r7:0096fdfc
r8:f7ba58d5 r9:f7baea86 r10:f7cadd38
fp:ffd27308 ip:f7cb2078 sp:ffd272a0 lr:f7c7ab98 pc:0096ad22
Memory near registers:  <-  故障现场寄存器附近内存
r4([stack]):
    ffd27e30 72656873
    ffd27e34 7070635f
    ...
    ffd27eac 3d73746f
r5(/system/bin/crasher_cpp):
    0096dff8 00000000
    0096dffc 0096717d
    ...
    0096e074 00000000
r7(/system/lib/ld-musl-arm.so.1):
    f7cabb58 00000000
    f7cabb5c 0034ba00
    ...
    f7cabbd4 00000000
r8(/system/lib/ld-musl-arm.so.1):
    f7ba58cc 63637573
    f7ba58d0 2e737365
    ...
    f7ba5948 70206269
r9(/system/lib/ld-musl-arm.so.1):
    f7baea7c 20746f6e
    f7baea80 6e756f66
    ...
    f7baeaf8 25206e69
r10([anon:ld-musl-arm.so.1.bss]):
    f7cadd30 00000000
    f7cadd34 00000000
    ...
    f7caddac 00000000
r12([anon:ld-musl-arm.so.1.bss]):
    f7cb2070 56726562
    f7cb2074 65756c61
    ...
    f7cb20ec 00000000
sp([stack]):
    ffd27328 00000000
    ffd2732c 00966dd0
    ...
    ffd273a4 00000004
pc(/system/bin/crasher_cpp):
    00966dc8 e1a0d00c
    00966dcc eb000000
    ...
    00966e44 e5907008
pc(/system/bin/crasher_cpp):
    00966dc8 e1a0d00c
    00966dcc eb000000
    ...
    00966e44 e5907008
FaultStack:   <- 崩溃线程的栈地址空间
    ffd27260 00000000
    ffd27264 f7cac628
    ...
    ffd2729c 0096ad1f
sp0:ffd272a0 0096fdfc <- #00栈顶
    ffd272a4 009684d3
sp1:ffd272a8 00000001
    ffd272ac 73657408
    ffd272b0 f7590074
    ...
    ffd272dc 0096856d
sp2:ffd272e0 ffd27334
    ffd272e4 ffd27334
    ffd272e8 00000002
    ....
    ffd272f4 f7bfbb9c
sp3:ffd272f8 00000000
    ffd272fc ffd27334

Maps:   <-  故障时进程maps
962000-966000 r--p 00000000 /system/bin/crasher_cpp
966000-96c000 r-xp 00003000 /system/bin/crasher_cpp
96c000-96f000 r--p 00008000 /system/bin/crasher_cpp
96f000-970000 rw-p 0000a000 /system/bin/crasher_cpp
149f000-14a0000 ---p 00000000 [heap]
14a0000-14a2000 rw-p 00000000 [heap]
...
f7b89000-f7be1000 r--p 00000000 /system/lib/ld-musl-arm.so.1
f7be1000-f7ca9000 r-xp 00057000 /system/lib/ld-musl-arm.so.1
f7ca9000-f7cab000 r--p 0011e000 /system/lib/ld-musl-arm.so.1
f7cab000-f7cad000 rw-p 0011f000 /system/lib/ld-musl-arm.so.1
f7cad000-f7cbc000 rw-p 00000000 [anon:ld-musl-arm.so.1.bss]
ffd07000-ffd28000 rw-p 00000000 [stack]
ffff0000-ffff1000 r-xp 00000000 [vectors]
OpenFiles: <- 故障时进程打开文件Fd信息
0->/dev/pts/1 native object of unknown type 0
1->/dev/pts/1 native object of unknown type 0
2->/dev/pts/1 native object of unknown type 0
3->socket:[69219] native object of unknown type 0
...
11->pipe:[69224] native object of unknown type 0
12->socket:[29074] native object of unknown type 0
25->/dev/ptmx native object of unknown type 0
26->/dev/ptmx native object of unknown type 0
```

### 日志格式 - 异步线程场景故障
（目前支持ARM64架构，且在调试应用（HAP_DEBUGGABLE）下开启）

以下是一份DevEco Studio归档在FaultLog的进程崩溃日志的核心内容，与`设备/data/log/faultlog/faultlogger`下归档的日志内容相同。

```
Generated by HiviewDFX@OpenHarmony
================================================================
Device info:OpenHarmony 3.2                 <- 设备信息
Build info:OpenHarmony 5.0.0.23             <- 版本信息
Fingerprint:8bc3343f50024204e258b8dce86f41f8fcc50c4d25d56b24e71fe26c0a23e321  <- 标识故障特征
Module name:crasher_cpp                     <- 模块名
Timestamp:2024-05-06 20:28:24.000           <- 故障发生时间戳
Pid:9838                                    <- 进程号
Uid:0                                       <- 用户ID
Process name:./crasher_cpp                  <- 进程名称
Process life time:2s                        <- 进程存活时间
Reason:Signal:SIGSEGV(SI_TKILL)@0x000000000004750  from:18256:0  <- 故障原因
Fault thread info:
Tid:18257, Name:crasher_cpp                 <- 故障线程号,线程名
#00 pc 000054e6 /system/bin/ld-musl-aarch64.so.l(raise+228)(adfc673300571d2da1e47d1d12f48b44)  <- 调用栈
#01 pc 000054f9 /system/bin/crasher_cpp(CrashInSubThread(void*)+56)(adfc673300571d2da1e47d1d12f48b50)
#02 pc 000054f9 /system/bin/ld-musl-aarch64.so.l(start+236)(adfc673300571d2da1e47d1d12f48b44)
========SubmitterStacktrace========       <- 任务异常时打印任务提交者调用栈
#00 pc 000094dc /system/bin/crasher_cpp(DfxCrasher::AsyncStacktrace()+36)(adfc673300571d2da1e47d1d12f48b50)
#01 pc 00009a58 /system/bin/crasher_cpp(DfxCrasher::ParseAndDoCrash(char const*) const+232)(adfc673300571d2da1e47d1d12f48b50)
#02 pc 00009b40 /system/bin/crasher_cpp(main+140)(adfc673300571d2da1e47d1d12f48b50)
#03 pc 0000a4e1c /system/bin/ld-musl-aarch64.so.l(libc_start_main_stage2+68)(adfc673300571d2da1e47d1d12f48b44)
Registers:    <- 故障现场寄存器
r0:00000001 r1:00000000 r2:f76b7ffc r3:00000004
r4:f76b7ffc r5:00000000 r6:f76bad14 r7:000000af
r8:f78514a0 r9:f76bad28 r10:f76bad1c
fp:f76bad08 ip:00000004 sp:f76b7ff8 lr:00a544fd pc:00a544e6
Other thread info:   <- 其他线程信息
Tid:18256, Name:crasher_cpp   <- 线程号,线程名
#00 pc 00103cbc /system/lib/ld-musl-arm.so.1(__timedwait_cp+200)(d820b1827e57855d4f9ed03ba5dfea83)  <- 调用栈
#01 pc 00109284 /system/lib/ld-musl-arm.so.1(__pthread_mutex_timedlock_inner+692)(d820b1827e57855d4f9ed03ba5dfea83)
#02 pc 000811c0 /system/lib/ld-musl-arm.so.1(PauseMainThreadHandler+84)(d820b1827e57855d4f9ed03ba5dfea83)
#03 pc 0007029c /system/lib/ld-musl-arm.so.1(d820b1827e57855d4f9ed03ba5dfea83)
#04 pc 00107f68 /system/lib/ld-musl-arm.so.1(__pthread_join+88)(d820b1827e57855d4f9ed03ba5dfea83)
#05 pc 00005489 /system/bin/crasher_cpp(DfxCrasher::StackOverflow()+152)(adfc673300571d2da1e47d1d12f48b44)
#06 pc 000064d1 /system/bin/crasher_cpp(DfxCrasher::ParseAndDoCrash(char const*) const+160)(adfc673300571d2da1e47d1d12f48b44)
#07 pc 00006569 /system/bin/crasher_cpp(main+92)(adfc673300571d2da1e47d1d12f48b44)
#08 pc 00072b98 /system/lib/ld-musl-arm.so.1(libc_start_main_stage2+56)(d820b1827e57855d4f9ed03ba5dfea83)
#09 pc 00004e28 /system/bin/crasher_cpp(_start_c+84)(adfc673300571d2da1e47d1d12f48b44)
#10 pc 00004dcc /system/bin/crasher_cpp(adfc673300571d2da1e47d1d12f48b44)
Memory near registers:  <-  故障现场寄存器附近内存
r6([anon:stack:9839]):
    f76bad0c f779845c
    f76bad10 00000000
    ...
    f76bad88 f7851990
r8([anon:ld-musl-arm.so.1.bss]):
    f7851498 00000000
    f785149c 00000000
    ...
    f7851514 00000000
r9([anon:stack:9839]):
    f76bad20 00000000
    f76bad24 00000000
    ...
    f76bad9c 00000000
r10([anon:stack:9839]):
    f76bad14 00a544bd
    f76bad18 00000000
    ...
    f76bad90 00000000
fp([stack]):
    fffe8fd0 000011f0
    fffe8fd4 00a5cdfc
    ...
    fffe904c 975ddb02
sp([anon:stack:9839]):
    f76bad08 fffe8fd8
    f76bad0c f779845c
    ...
    f76bad84 00000000
pc(/system/lib/ld-musl-arm.so.1):
    f7798454 e1a00006
    f7798458 eb000002
    ...
    f77984d0 eb000169
pc(/system/lib/ld-musl-arm.so.1):
    f7798454 e1a00006
    f7798458 eb000002
    ...
    f77984d0 eb000169
FaultStack:  <- 崩溃线程的栈地址空间
    f76b7fb8 00000000
    f76b7fbc 00000000
    ...
    f76b7ff4 00000000
sp0:f76b7ff8 00000000  <- #00栈顶
    f76b7ffc 00000000
    ...
    f76b8034 00a544fd
sp1:f76b8038 00000000
    f76b803c 00000001
    ...
    f76b8074 00a544fd
sp2:f76b8078 00000000
    f76b807c 00000001
    ...
    f76b80b4 00a544fd
sp3:f76b80b8 00000000
    f76b80bc 00000001
    ...
    f76b80e4 975ddb02

Maps:    <-  故障时进程maps
a4f000-a53000 r--p 00000000 /system/bin/crasher_cpp
a53000-a59000 r-xp 00003000 /system/bin/crasher_cpp
a59000-a5c000 r--p 00008000 /system/bin/crasher_cpp
a5c000-a5d000 rw-p 0000a000 /system/bin/crasher_cpp
e4e000-e4f000 ---p 00000000 [heap]
e4f000-e51000 rw-p 00000000 [heap]
...
f7728000-f7780000 r--p 00000000 /system/lib/ld-musl-arm.so.1
f7780000-f7848000 r-xp 00057000 /system/lib/ld-musl-arm.so.1
f7848000-f784a000 r--p 0011e000 /system/lib/ld-musl-arm.so.1
f784a000-f784c000 rw-p 0011f000 /system/lib/ld-musl-arm.so.1
f784c000-f785b000 rw-p 00000000 [anon:ld-musl-arm.so.1.bss]
fffc9000-fffea000 rw-p 00000000 [stack]
ffff0000-ffff1000 r-xp 00000000 [vectors]
OpenFiles:     <-  故障时进程打开文件Fd信息
0->/dev/pts/1 native object of unknown type 0
1->/dev/pts/1 native object of unknown type 0
2->/dev/pts/1 native object of unknown type 0
3->socket:[68408] native object of unknown type 0
...
11->pipe:[68414] native object of unknown type 0
12->socket:[29074] native object of unknown type 0
25->/dev/ptmx native object of unknown type 0
26->/dev/ptmx native object of unknown type 0

HiLog:     <-  故障时的Hilog日志
05-06 20:28:24.089  9838  9839 E C03f00/MUSL-SIGCHAIN: signal_chain_handler call 2 rd sigchain action for signal: 11
05-06 20:28:24.089  9838  9839 I C02d11/DfxSignalHandler: DFX_SigchainHandler :: sig(11), pid(9838), tid(9839).
05-06 20:28:24.089  9838  9839 I C02d11/DfxSignalHandler: Try block main thread.
05-06 20:28:24.089  9838  9838 I C02d11/DfxSignalHandler: Crash(3) in child thread(9838), lock main thread.
05-06 20:28:24.090  9838  9839 I C02d11/DfxSignalHandler: DFX_SigchainHandler :: sig(11), pid(9838), processName(./crasher_cpp), threadName(crasher_cpp).
05-06 20:28:24.122  9838  9839 I C02d11/DfxSignalHandler: processdump have get all resgs
```


通过Shell获取的`/data/log/faultlog/temp`获取到的日志内容格式如下：


```
Timestamp:2024-05-06 20:28:24.000           <- 故障发生时间戳
Pid:9838                                    <- 进程号
Uid:0                                       <- 用户ID
Process name:./crasher_cpp                  <- 进程名称
Process life time:2s                        <- 进程存活时间
Reason:Signal:SIGSEGV(SI_TKILL)@0x000000000004750  from:18256:0           <- 故障原因
Fault thread info:
Tid:18257, Name:crasher_cpp                 <- 故障线程号,线程名
#00 pc 000054e6 /system/bin/ld-musl-aarch64.so.l(raise+228)(adfc673300571d2da1e47d1d12f48b44)  <- 调用栈
#01 pc 000054f9 /system/bin/crasher_cpp(CrashInSubThread(void*)+56)(adfc673300571d2da1e47d1d12f48b50)
#02 pc 000054f9 /system/bin/ld-musl-aarch64.so.l(start+236)(adfc673300571d2da1e47d1d12f48b44)
========SubmitterStacktrace========         <- 任务异常时打印任务提交者调用栈
#00 pc 000094dc /system/bin/crasher_cpp(DfxCrasher::AsyncStacktrace()+36)(adfc673300571d2da1e47d1d12f48b50)
#01 pc 00009a58 /system/bin/crasher_cpp(DfxCrasher::ParseAndDoCrash(char const*) const+232)(adfc673300571d2da1e47d1d12f48b50)
#02 pc 00009b40 /system/bin/crasher_cpp(main+140)(adfc673300571d2da1e47d1d12f48b50)
#03 pc 0000a4e1c /system/bin/ld-musl-aarch64.so.l(libc_start_main_stage2+68)(adfc673300571d2da1e47d1d12f48b44)
Registers:    <- 故障现场寄存器
r0:00000001 r1:00000000 r2:f76b7ffc r3:00000004
r4:f76b7ffc r5:00000000 r6:f76bad14 r7:000000af
r8:f78514a0 r9:f76bad28 r10:f76bad1c
fp:f76bad08 ip:00000004 sp:f76b7ff8 lr:00a544fd pc:00a544e6
Other thread info:   <- 其他线程信息
Tid:18256, Name:crasher_cpp   <- 线程号,线程名
#00 pc 00103cbc /system/lib/ld-musl-arm.so.1(__timedwait_cp+200)(d820b1827e57855d4f9ed03ba5dfea83)  <- 调用栈
#01 pc 00109284 /system/lib/ld-musl-arm.so.1(__pthread_mutex_timedlock_inner+692)(d820b1827e57855d4f9ed03ba5dfea83)
#02 pc 000811c0 /system/lib/ld-musl-arm.so.1(PauseMainThreadHandler+84)(d820b1827e57855d4f9ed03ba5dfea83)
#03 pc 0007029c /system/lib/ld-musl-arm.so.1(d820b1827e57855d4f9ed03ba5dfea83)
#04 pc 00107f68 /system/lib/ld-musl-arm.so.1(__pthread_join+88)(d820b1827e57855d4f9ed03ba5dfea83)
#05 pc 00005489 /system/bin/crasher_cpp(DfxCrasher::StackOverflow()+152)(adfc673300571d2da1e47d1d12f48b44)
#06 pc 000064d1 /system/bin/crasher_cpp(DfxCrasher::ParseAndDoCrash(char const*) const+160)(adfc673300571d2da1e47d1d12f48b44)
#07 pc 00006569 /system/bin/crasher_cpp(main+92)(adfc673300571d2da1e47d1d12f48b44)
#08 pc 00072b98 /system/lib/ld-musl-arm.so.1(libc_start_main_stage2+56)(d820b1827e57855d4f9ed03ba5dfea83)
#09 pc 00004e28 /system/bin/crasher_cpp(_start_c+84)(adfc673300571d2da1e47d1d12f48b44)
#10 pc 00004dcc /system/bin/crasher_cpp(adfc673300571d2da1e47d1d12f48b44)
Memory near registers:  <-  故障现场寄存器附近内存
r6([anon:stack:9839]):
    f76bad0c f779845c
    f76bad10 00000000
    ...
    f76bad88 f7851990
r8([anon:ld-musl-arm.so.1.bss]):
    f7851498 00000000
    f785149c 00000000
    ...
    f7851514 00000000
r9([anon:stack:9839]):
    f76bad20 00000000
    f76bad24 00000000
    ...
    f76bad9c 00000000
r10([anon:stack:9839]):
    f76bad14 00a544bd
    f76bad18 00000000
    ...
    f76bad90 00000000
fp([stack]):
    fffe8fd0 000011f0
    fffe8fd4 00a5cdfc
    ...
    fffe904c 975ddb02
sp([anon:stack:9839]):
    f76bad08 fffe8fd8
    f76bad0c f779845c
    ...
    f76bad84 00000000
pc(/system/lib/ld-musl-arm.so.1):
    f7798454 e1a00006
    f7798458 eb000002
    ...
    f77984d0 eb000169
pc(/system/lib/ld-musl-arm.so.1):
    f7798454 e1a00006
    f7798458 eb000002
    ...
    f77984d0 eb000169
FaultStack:  <- 崩溃线程的栈地址空间
    f76b7fb8 00000000
    f76b7fbc 00000000
    ...
    f76b7ff4 00000000
sp0:f76b7ff8 00000000  <- #00栈顶
    f76b7ffc 00000000
    ...
    f76b8034 00a544fd
sp1:f76b8038 00000000
    f76b803c 00000001
    ...
    f76b8074 00a544fd
sp2:f76b8078 00000000
    f76b807c 00000001
    ...
    f76b80b4 00a544fd
sp3:f76b80b8 00000000
    f76b80bc 00000001
    ...
    f76b80e4 975ddb02

Maps:    <-  故障时进程maps
a4f000-a53000 r--p 00000000 /system/bin/crasher_cpp
a53000-a59000 r-xp 00003000 /system/bin/crasher_cpp
a59000-a5c000 r--p 00008000 /system/bin/crasher_cpp
a5c000-a5d000 rw-p 0000a000 /system/bin/crasher_cpp
e4e000-e4f000 ---p 00000000 [heap]
e4f000-e51000 rw-p 00000000 [heap]
...
f7728000-f7780000 r--p 00000000 /system/lib/ld-musl-arm.so.1
f7780000-f7848000 r-xp 00057000 /system/lib/ld-musl-arm.so.1
f7848000-f784a000 r--p 0011e000 /system/lib/ld-musl-arm.so.1
f784a000-f784c000 rw-p 0011f000 /system/lib/ld-musl-arm.so.1
f784c000-f785b000 rw-p 00000000 [anon:ld-musl-arm.so.1.bss]
fffc9000-fffea000 rw-p 00000000 [stack]
ffff0000-ffff1000 r-xp 00000000 [vectors]
OpenFiles:     <-  故障时进程打开文件Fd信息
0->/dev/pts/1 native object of unknown type 0
1->/dev/pts/1 native object of unknown type 0
2->/dev/pts/1 native object of unknown type 0
3->socket:[68408] native object of unknown type 0
...
11->pipe:[68414] native object of unknown type 0
12->socket:[29074] native object of unknown type 0
25->/dev/ptmx native object of unknown type 0
26->/dev/ptmx native object of unknown type 0
```

### 通过日志定位问题

1. 通过故障日志等基础信息确定问题模块和故障类别。

   通过崩溃进程名一般能定界到故障的模块，通过信号能判断崩溃的原因，通过堆栈中的方法名，可以复原崩溃栈的函数调用链。

   如范例中的SIGSEGV是由Linux内核抛出，原因为访问了非法内存地址，问题发生在SegmentFaultException函数中。

   大部分场景下崩溃栈的最上层就是崩溃的原因，如空指针访问以及程序主动终止运行。少部分场景调用栈无法定位原因，需要查看其他信息，例如踩内存或者栈溢出的问题场景可以查看寄存器信息和maps等内容。

2. 通过addr2line工具解析出代码行号来复原崩溃现场调用栈。

   使用Linux addr2line工具解析崩溃栈的行号，需要使用带调试信息的二进制。一般在版本编译或者应用编译时会生成带调试信息的二进制。

   应用二进制位置在DevEco Studio应用构建的临时目录中，如`build/default/intermediates/libs`。系统二进制位置在如下目录，对于直接获取的版本，二进制会归档在完整镜像包中。

   ```
   \代码根路径\out\产品\lib.unstripped
   \代码根路径\out\产品\exe.unstripped
   ```

   - Linux环境下，开发者可以通过apt-get install addr2line命令安装addr2line软件来使用。
   - 在应用开发环境下，开发者还可以使用SDK中归档的llvm-addr2line工具来解析行号，使用方法一致。

   使用llvm-addr2line工具根据偏移地址解析行号:

   [product name]为具体设备名。

   ```
   root:~/OpenHarmony/out/[product name]/exe.unstripped/hiviewdfx/faultloggerd$ llvm-addr2line -Cfie crasher 00007be6
   base/hiviewdfx/faultloggerd/tools/crasher/dfx_crasher.c:123
   ```

   示例中的崩溃故障是由于访问了空指针，代码行为dfx_crasher.c文件的123行。修改后可以避免发生此崩溃。

   另外，使用llvm-addr2line后，如果得出的行号看起来不是很正确，可以考虑对地址进行微调(如减1)，或者考虑关闭一些编译优化，已知使用LTO的二进制可能无法正确获得行号。